<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Mindful Journal (No NPM)</title>
</head>
<body>
  <h1>Mindful Journal</h1>
  
  <!-- Simple UI -->
  <textarea id="journalContent" placeholder="Write your journal..."></textarea>
  <br/>
  <label>
    <input type="checkbox" id="publicToggle" /> Make Public
  </label>
  <br/>
  <button id="createJournalBtn">Create Journal</button>
  <p id="statusMsg"></p>

  <!-- Display previous journal entries -->
  <div id="journals"></div>

  <!-- 1. ethers (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.umd.min.js"></script>

  <!-- 2. Firebase (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js"></script>

  <!-- 3. Your Custom JavaScript -->
  <script>
    // =======================
    // Firebase Configuration
    // =======================
    const firebaseConfig = {
      apiKey: "AIzaSyCiawo_DNjM35XQRj-2FcTCmNai0weth7g",
      authDomain: "mindfuljournal-c5bf0.firebaseapp.com",
      projectId: "mindfuljournal-c5bf0",
      storageBucket: "mindfuljournal-c5bf0.appspot.com",
      messagingSenderId: "983633163512",
      appId: "1:983633163512:web:4949d3cf427cd9e668f70d",
      measurementId: "G-8QWRCF39M4"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =======================
    // Smart Contract Setup
    // =======================
    const contractAddress = "0xD7ACd2a9FD159E69Bb102A1ca21C9a3e3A5F771B";
    const abi = [
  {
    "type": "event",
    "name": "JournalCreated",
    "inputs": [
      { "name": "user", "type": "address", "indexed": false },
      { "name": "entry_id", "type": "uint256", "indexed": false },
      { "name": "is_public", "type": "bool", "indexed": false }
    ],
    "anonymous": false
  },
  {
    "type": "constructor",
    "stateMutability": "nonpayable",
    "inputs": [
      { "name": "_token", "type": "address" },
      { "name": "_token_required", "type": "uint256" }
    ]
  },
  {
    "type": "function",
    "name": "create_journal",
    "stateMutability": "nonpayable",
    "inputs": [
      { "name": "content", "type": "string" },
      { "name": "is_public", "type": "bool" }
    ],
    "outputs": []
  },
  {
    "type": "function",
    "name": "view_journal",
    "stateMutability": "view",
    "inputs": [
      { "name": "entry_id", "type": "uint256" }
    ],
    "outputs": [
      { "name": "", "type": "string" }
    ]
  },
  {
    "type": "function",
    "name": "toggle_privacy",
    "stateMutability": "nonpayable",
    "inputs": [
      { "name": "entry_id", "type": "uint256" }
    ],
    "outputs": []
  },
  {
    "type": "function",
    "name": "journal_token",
    "stateMutability": "view",
    "inputs": [],
    "outputs": [
      { "name": "", "type": "address" }
    ]
  },
  {
    "type": "function",
    "name": "journals",
    "stateMutability": "view",
    "inputs": [
      { "name": "arg0", "type": "uint256" }
    ],
    "outputs": [
      {
        "name": "",
        "type": "tuple",
        "components": [
          { "name": "owner", "type": "address" },
          { "name": "content", "type": "string" },
          { "name": "is_public", "type": "bool" }
        ]
      }
    ]
  },
  {
    "type": "function",
    "name": "user_journal_count",
    "stateMutability": "view",
    "inputs": [
      { "name": "arg0", "type": "address" }
    ],
    "outputs": [
      { "name": "", "type": "uint256" }
    ]
  },
  {
    "type": "function",
    "name": "token_required",
    "stateMutability": "view",
    "inputs": [],
    "outputs": [
      { "name": "", "type": "uint256" }
    ]
  }
];


    let provider;
    let signer;
    let contract;

    // Initialize Ethers.js and Metamask
    async function initEthers() {
      if (window.ethereum) {
        provider = new ethers.providers.Web3Provider(window.ethereum);
        await provider.send("eth_requestAccounts", []);
        signer = provider.getSigner();
        contract = new ethers.Contract(contractAddress, abi, signer);
      } else {
        alert("Please install Metamask or use a Web3 browser.");
      }
    }

    // =======================
    // Create Journal Function
    // =======================
    async function createJournal() {
      try {
        const content = document.getElementById("journalContent").value;
        const isPublic = document.getElementById("publicToggle").checked;

        if (!content.trim()) {
          alert("Please enter a journal entry.");
          return;
        }

        document.getElementById("statusMsg").textContent = "Processing...";

        // 1️⃣ Ensure blockchain connection
        if (!contract) {
          await initEthers();
        }

        // 2️⃣ Submit journal to blockchain
        let tx = await contract.create_journal(content, isPublic);
        document.getElementById("statusMsg").textContent = "Transaction sent! Waiting for confirmation...";
        await tx.wait();
        document.getElementById("statusMsg").textContent = "Journal entry created on blockchain!";

        // 3️⃣ Save to Firebase Firestore
        const userAddress = await signer.getAddress();
        await db.collection("journals").add({
          owner: userAddress,
          content: content,
          is_public: isPublic,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });

        alert("Journal saved to Firebase!");
        loadJournals(); // Refresh displayed journals

      } catch (error) {
        console.error(error);
        document.getElementById("statusMsg").textContent = "Error creating journal entry.";
      }
    }

    // =======================
    // Load and Display Journals from Firebase
    // =======================
    async function loadJournals() {
      const journalsDiv = document.getElementById("journals");
      journalsDiv.innerHTML = "<h2>Loading journals...</h2>";

      try {
        const querySnapshot = await db.collection("journals").orderBy("timestamp", "desc").get();

        journalsDiv.innerHTML = "<h2>Previous Journal Entries:</h2>";
        querySnapshot.forEach((doc) => {
          const entry = doc.data();
          journalsDiv.innerHTML += `
            <p><strong>${entry.owner}:</strong> ${entry.content} (${entry.is_public ? "Public" : "Private"})</p>
          `;
        });
      } catch (error) {
        console.error("Error loading journals:", error);
        journalsDiv.innerHTML = "<p>Error loading journals.</p>";
      }
    }

    // =======================
    // Event Listeners
    // =======================
    document.getElementById("createJournalBtn").addEventListener("click", createJournal);

    // Auto-load journals on page load
    window.onload = loadJournals;
  </script>

</body>
</html>
